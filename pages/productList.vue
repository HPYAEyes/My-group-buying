<template>
  <div class="product-list-container">
    <!-- filter start -->
    <div class="filter">
      <div class="filter-box">
        <span class="filter-title">分类：</span>
        <filterbox
          :data="filterType.typeList"
          :default.sync="filterType.choosedType"
          :label="filterType.label"
          :value="filterType.value"
          @change="handleTypeChange"/>
      </div>
      <div class="filter-box">
        <span class="filter-title">地点：</span>
        <filterbox
          :data="filterPlace.placeList"
          :default.sync="filterPlace.choosedPlace"
          :label="filterPlace.label"
          :value="filterPlace.value"
          @change="handlePlaceChange"/>
      </div>
      <div class="filter-box" v-if="filterPlace.choosedPlace !== '全部'">
        <span class="filter-title">街道：</span>
        <filterbox
          :data="filterStreet.streetList"
          :default.sync="filterStreet.choosedStreet"
          :label="filterStreet.label"
          :value="filterStreet.value"
          :key="filterStreet.choosedStreet"
          @change="handleStreetChange"/>
      </div>
    </div>
    <!-- filter end -->
    <div class="product">
      <div class="product-header">
        <el-radio-group v-model="listSort" size="small">
          <el-radio-button label="默认"></el-radio-button>
          <el-radio-button label="价格排序"></el-radio-button>
          <el-radio-button label="人气最高"></el-radio-button>
          <el-radio-button label="评价最高"></el-radio-button>
        </el-radio-group>
      </div>
      <ul class="product-list">
        <li
          class="product-item"
          v-for="item in productList"
          :key="item._id">
          <nuxt-link :to="'/productDetail?id=' + item._id"><img class="item-img" :src="item.imgUrl[0]" :alt="item.name"></nuxt-link>
          <div class="item-content">
            <nuxt-link class="item-header" :to="'/productDetail?id=' + item._id">{{ item.name }}</nuxt-link>
            <div class="item-comment">
              <el-rate
                v-model="item.averRate"
                text-color="#ff9900"
                disabled
                allow-half
                show-score></el-rate>
              <span style="color:#409eff">{{ item.commentCount }}人评论</span>
            </div>
            <div class="item-place">
              <span>{{ item.type }}</span>
              <span style="color: #ccc">|</span>
              <span>{{ item.place }}</span>
              <span>{{ item.address }}</span>
            </div>
            <div class="item-price">人均￥{{ item.price }}</div>
            <div class="item-ticket">
              <i class="iconfont tg-tuan main-color"></i>
              <el-tooltip 
                effect="dark"
                :content="item.description"
                placement="top">
                <p class="text-overflow">{{ item.description }}</p>
              </el-tooltip>
            </div>
          </div>
        </li>
        <li class="product-pagination">
          <el-pagination
            layout="prev, pager, next"
            :page-size="pageInfo.pageSize"
            :current-page.sync="pageInfo.pageNum"
            :total="pageInfo.totalRecords"
            @current-change="handlePageChange">
          </el-pagination>
        </li>
      </ul>
      <div class="product-recommand hot-recommand">
        <p>近期热门推荐</p>
        <ul>
          <li>
            <a href="#">
              <img src="../assets/img/img1.jpg" alt="">
              <p>悦壹生视力矫正中心</p>
              <div class="comment">
                <el-rate
                  v-model="rate"
                  disabled
                  allow-half></el-rate>
                <span class="count">22个评价</span>
              </div>
              <p class="address">北景园</p>
              <p class="price">人均￥<span>92</span></p>
            </a>
          </li>
          <li>
            <a href="#">
              <img src="../assets/img/img1.jpg" alt="">
              <p>悦壹生视力矫正中心</p>
              <div class="comment">
                <el-rate
                  v-model="rate"
                  disabled
                  allow-half></el-rate>
                <span class="count">22个评价</span>
              </div>
              <p class="address">北景园</p>
              <p class="price">人均￥<span>92</span></p>
            </a>
          </li>
          <li>
            <a href="#">
              <img src="../assets/img/img1.jpg" alt="">
              <p>悦壹生视力矫正中心</p>
              <div class="comment">
                <el-rate
                  v-model="rate"
                  disabled
                  allow-half></el-rate>
                <span class="count">22个评价</span>
              </div>
              <p class="address">北景园</p>
              <p class="price">人均￥<span>92</span></p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="product-amap">
      <no-ssr>
        <el-amap
          ref="amap"
          vid="myamap"
          :center="gdMap.center"
          :zoom="gdMap.zoom"
          :map-manager="gdMap.amapManager"
          :events="gdMap.events">
        </el-amap>
      </no-ssr>
    </div>

  </div>
</template>
<script>
import Filterbox from '@/components/public/filterbox.vue';
import { AMapManager } from 'vue-amap';
import { createNamespacedHelpers  } from 'vuex';
import {
  queryTypeList,
  queryPlaceList,
  queryProductList
} from 'api/product';

const { mapState, mapActions } = createNamespacedHelpers('product');

export default {
  name: 'productList',
  data() {
    return {
      gdMap: {
        zoom: 11,
        center: ['121.59996', '31.197646'],
        amapManager: AMapManager,
      },
      filterPlace: {
        choosedPlace: '全部',
        placeList: [],
        label: 'name',
        value: 'adcode'
      },
      filterStreet: {
        choosedStreet: '全部',
        streetList: [],
        label: 'name',
        value: 'name'
      },
      productList: [],
      pageInfo: {
        pageSize: 12,
        pageNum: 1,
        totalRecords: 0
      },
      rate: 4.5,
      listSort: '默认'
    };
  },
  components: {
    Filterbox
  },
  async asyncData({ store }) {
    const { data: { data: typeList } } = await queryTypeList();
    return {
      filterType: {
        choosedType: '全部',
        typeList,
        label: 'name',
        value: 'name'
      },
    }
  },
  async mounted() {
    const { data: { data: { areaList: placeList } } } = await queryPlaceList(this.$store.state.geo.choosedCity.adcode);
    this.filterPlace.placeList = placeList;
    console.log(placeList);
    this.getProductList();
    const self = this;
    this.gdMap.events = {
      init(map) {
        AMapUI.loadUI(['overlay/SimpleMarker'], (SimpleMarker) =>{
          self.productList.forEach((item, index) => {
            const marker = new SimpleMarker({
              iconStyle: `red-${index + 1}`,
              iconTheme: 'numv2',
              map,
              position: [item.lng, item.lat]
            });
            marker.on('click', () => {
              console.log([item.lng, item.lat]);
            }, self);
          });
        });
      }
    }
  },
  methods: {
    /**
     * @description 获取团购信息列表
     */
    getProductList() {
      const type = this.filterType.choosedType === '全部' ? undefined : this.filterType.choosedType;
      const street = this.filterStreet.choosedStreet === '全部' ? undefined : this.filterStreet.choosedStreet;
      const adcode = this.filterPlace.choosedPlace === '全部' ? undefined : this.filterPlace.choosedPlace;
      // TODO sort
      const sort = 0;
      const params = {
        pageNum: this.pageInfo.pageNum,
        pageSize: this.pageInfo.pageSize,
        cityCode: this.$store.state.geo.choosedCity.adcode,
        adcode,
        sort,
        type,
        street
      };
      queryProductList(params).then((resp) => {
        const { data } = resp.data;
        this.productList = data.productList;
        this.pageInfo.totalRecords = data.totalRecords;
        this.gdMap.center = [this.productList[0].lng, this.productList[0].lat];
      });
    },
    /**
     * @description 处理分页
     */
    handlePageChange() {
      this.getProductList();
    },
    handleTypeChange(val) {
      console.log(val);
    },
    /**
     * @description 选择的地点改变时的处理
     */
    handlePlaceChange(val) {
      console.log(val);
      this.filterStreet.choosedStreet = '全部';
      this.filterStreet.streetList = val === '全部' ? [] : val.districts;
    },
    handleStreetChange(val) {
      console.log(val);
    }

  }
}
</script>
<style lang="scss">
@import "../assets/css/variable.scss";

.product-list-container {
  width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-wrap: wrap;

  .filter {
    width: 100%;
    margin-top: 30px;
    margin-bottom: 16px;
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid $border;
    border-radius: 4px;
    background-color: #fff;
    font-size: 12px;

    .filter-box {
      display: flex;
      margin-bottom: 20px;

      &:last-child {
        margin-bottom: 0;
      }

      .filter-title {
        padding: 4px;
        flex-basis: 50px;
        color: $lightFont;
      }
    }
  }

  .product {
    position: relative;
    width: 75%;
    min-height: 100vh;
    margin-right: 16px;
    margin-bottom: 16px;
    padding: 0 20px;
    border: 1px solid $border;
    border-radius: 4px;
    background-color: #fff;

    .product-header {
      height: 40px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid $border;
      font-size: 12px;

      .el-radio-button__orig-radio:checked+.el-radio-button__inner {
        color: $mainColor;
        background-color: #fff;
        box-shadow: none;
      }

      .el-radio-button--small {
        &:first-child {
          .el-radio-button__inner {
            padding: 9px 14px 9px 0;
          }
        }
      }

      .el-radio-button {
        .el-radio-button__inner {
          border: 0;
          border-radius: 0;
        }
      }

    }

    .product-list {

      .product-item {
        display: flex;
        padding: 20px 0;
        border-bottom: 1px solid $border;

        &:last-child {
          border-bottom: 0;
        }

        .item-img {
          width: 220px;
          height: 125px;
          border-radius: 6px;
        }

        .item-content {
          width: 500px;
          flex-grow: 1;
          display: flex;
          flex-direction: column;
          margin-left: 20px;
          font-size: 12px;
          color: $lightFont;

          .item-header {
            font-size: 16px;
            color: $mainFont;
          }

          .item-comment {
            display: flex;
            align-items: center;
            margin-top: 8px;

            >span {
              margin-left: 10px;
            }
          }

          .item-place {
            margin-top: 8px;

            span {
              margin-right: 4px;
            }
          }

          .item-price {
            margin-top: 8px;
          }

          .item-ticket {
            display: flex;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed $border;

            .main-color {
              color: $mainColor;
            }

            p {
              margin-left: 6px;
            }
          }
        }
      }
      
      .product-pagination {
        display: flex;
        justify-content: center;
        margin: 16px 0;
      }
    }
  }

  .product-amap {
    flex-grow: 1;
    height: 250px;
    border: 1px solid $border;
    border-radius: 4px;
  }

  .product-recommand {
    position: absolute;
    top: 270px;
    right: -256px;
    width: calc(25% - 50px);
    border: 1px solid $border;
    border-radius: 4px;
  }
}
</style>
